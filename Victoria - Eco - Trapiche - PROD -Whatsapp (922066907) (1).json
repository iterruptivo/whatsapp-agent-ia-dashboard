{
  "name": "Victoria - Eco - Trapiche - PROD -Whatsapp (922066907)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-eco-victoria",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4144,
        -176
      ],
      "id": "db27d86a-d53d-4842-b44d-03de0e1f42cf",
      "name": "Webhook: Recibir WhatsApp",
      "webhookId": "53aca111-64dd-4669-8d1c-8b31a4ac89f1"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query[\"hub.challenge\"] }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -3472,
        -368
      ],
      "id": "b1169636-868a-419f-8113-d98e62218930",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "dbcc75b1-9deb-49c4-8f55-34b8d3c23455"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0d57ef7c-87b7-44a5-9374-4082c3398cac",
                    "leftValue": "={{ $json.body[\"hub.mode\"] }}",
                    "rightValue": "subscribe",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "verification"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d9c90a3f-fc16-4e84-bebb-2c87048cd4f1",
                    "leftValue": "={{ $json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -3728,
        -192
      ],
      "id": "aab56864-9c67-4dbb-a27b-2d8aad5d22ef",
      "name": "Switch"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=--- DOCUMENTO (fuente de verdad, no inventes nada) ---\n{{ $json.knowledgeBase || '' }}\n--- FIN ---\n\nINFORMACIÃ“N DEL USUARIO:\n{{ $json.nombre_actual ? \"Nombre: \" + $json.nombre_actual : \"AÃºn no ha proporcionado su nombre\" }}\n\nHISTORIAL DE CONVERSACIÃ“N:\n{{ $json.historial || '' }}\n\nINSTRUCCIÃ“N IMPORTANTE: Si ya conoces el nombre del usuario, NO vuelvas a pedirlo. NO te presentes de nuevo si ya iniciaste la conversaciÃ³n antes. ContinÃºa naturalmente la conversaciÃ³n.",
              "role": "system"
            },
            {
              "content": "={{ $json.userMessage || '' }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -1632,
        -320
      ],
      "id": "80fece52-8fcf-4ddf-ab98-ab6b48ec8a69",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "757095820830409",
        "recipientPhoneNumber": "={{ $node[\"Webhook: Recibir WhatsApp\"].json.body.entry[0].changes[0].value.contacts[0].wa_id }}\n",
        "textBody": "={{ $node[\"Code2\"].json.mensaje_bot_final }}",
        "additionalFields": {
          "previewUrl": false
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        160,
        288
      ],
      "id": "48d4517e-6aa6-4422-95ce-50742c8d45b3",
      "name": "Send message",
      "webhookId": "44567a64-e03d-4d93-9d5f-1bff4ba673cb",
      "credentials": {
        "whatsAppApi": {
          "id": "uVeIndqI3yCXSK6H",
          "name": "WhatsApp account (Business - iterruptivo cel 922066907)"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c1313a0d-5d8f-497f-a0d5-7dc9aeadf3e2",
              "leftValue": "=={{ $json.query['hub.mode'] }}",
              "rightValue": "subscribe",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3936,
        -352
      ],
      "id": "b63a0ae7-f72d-477d-8dae-7622cff7c8fc",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Entradas\n  const botResponse = $node[\"Message a model\"].json?.message?.content || \"\";\n  const telefono = $node[\"Code1\"].json.telefono || \"\";\n  const historialPrevio = $node[\"Code1\"].json.historial || \"\";\n  const userMessage = $node[\"Code1\"].json.userMessage || \"\";\n\n  const nombrePrevio = $node[\"Code1\"].json.nombre_actual || \"\";\n  const rubroPrevio = $node[\"Code1\"].json.rubro_previo || \"\";\n  const horarioPrevio = $node[\"Code1\"].json.horario_previo || \"\";\n\n  // Datos extraÃ­dos por GPT\n  const extractedRaw = $node[\"OpenAI - Extract Data\"].json?.message?.content;\n  let extracted = { nombre: \"\", rubro: \"\", horario_visita: \"\", horario_visita_fecha: \"\", horario_visita_hora: \"\"\n  };\n  try {\n    if (typeof extractedRaw === \"string\") extracted = JSON.parse(extractedRaw);\n    else if (typeof extractedRaw === \"object\" && extractedRaw) extracted = extractedRaw;\n  } catch (e) { /* default */ }\n\n  const nombre = (extracted.nombre || \"\").trim() || nombrePrevio;\n  const rubro = (extracted.rubro || \"\").trim() || rubroPrevio;\n  const horario = (extracted.horario_visita || \"\").trim() || horarioPrevio;\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // TIMESTAMP PRESERVATION LOGIC\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // Leer nuevo timestamp del parser\n  const nuevoTimestamp = $node[\"Parse Horario to Timestamp\"].json?.horario_visita_timestamp || null;\n\n  // Leer timestamp anterior de la BD (vÃ­a Code1)\n  const timestampPrevio = $node[\"Code1\"].json.timestamp_previo || null;\n\n  // PRESERVAR: Si nuevo es null, mantener el anterior\n  // Si nuevo NO es null, usar el nuevo (permite actualizar si usuario cambia horario)\n  const horario_visita_timestamp = nuevoTimestamp !== null ? nuevoTimestamp : timestampPrevio;\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // NOTIFICACION_ENVIADA PRESERVATION LOGIC\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // Leer estado de notificacion desde Code1 (desde BD)\n  const notificacionEnviada = $node[\"Code1\"].json.notificacion_previamente_enviada || false;\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  // Contar intentos\n  const noaMessages = (historialPrevio.match(/\\nAgenteIA:/g) || []).length;\n\n  let estado = \"en_conversacion\";\n  let debeForazarCierre = false;\n\n  // ---- LÃ“GICA INTELIGENTE DE ESTADOS ----\n\n  // 1. Si tiene TODOS los datos â†’ Lead completo (puede seguir preguntando)\n  if (nombre && rubro && horario) {\n    estado = \"lead_completo\";\n    debeForazarCierre = false;  // NUNCA forzar cierre si tiene datos completos\n  }\n  // 2. Si tiene ALGUNOS datos (parcial)\n  else if (nombre || rubro || horario) {\n    // Dar mÃ¡s oportunidades (15 intentos) porque muestra interÃ©s\n    if (noaMessages >= 15) {\n      estado = \"lead_incompleto\";\n      debeForazarCierre = true;\n    } else {\n      estado = \"en_conversacion\";\n      debeForazarCierre = false;\n    }\n  }\n  // 3. Si NO tiene NINGÃšN dato\n  else {\n    // Cerrar antes (10 intentos) porque no muestra interÃ©s real\n    if (noaMessages >= 10) {\n      estado = \"conversacion_abandonada\";\n      debeForazarCierre = true;\n    } else {\n      estado = \"en_conversacion\";\n      debeForazarCierre = false;\n    }\n  }\n\n  // ---- MENSAJE FINAL ----\n  let mensajeBot = botResponse;\n\n  // Solo forzar cierre si corresponde\n  if (debeForazarCierre) {\n    mensajeBot = \"Su caso es importante para nosotros, pronto un asesor especializado se comunicarÃ¡ con usted para atender sus consultas de forma detallada, mantÃ©ngase al pendiente por favor. ğŸ¤—\";\n  }\n\n  // Construir historial completo (NO duplicar mensaje de usuario, ya estÃ¡ en historialPrevio)\n  const historial_conversacion =\n    (historialPrevio ? historialPrevio + \"\\n\" : \"\") +\n    \"AgenteIA: \" + mensajeBot;\n\n  // Ãšltimos 10 mensajes\n  const lines = historial_conversacion.split(/\\r?\\n/).filter(Boolean);\n  const historial_reciente = lines.slice(-10).join(\"\\n\");\n\n  return [{\n    json: {\n      telefono: telefono,\n      nombre: nombre,\n      rubro: rubro,\n      horario_visita: horario,\n      horario_visita_timestamp: horario_visita_timestamp,\n      historial_conversacion,\n      historial_reciente,\n      fecha_captura: new Date().toISOString(),\n      ultimo_mensaje: userMessage,\n      estado: estado,\n      intentos_bot: noaMessages + 1,\n      mensaje_bot_final: mensajeBot,\n      notificacion_enviada: notificacionEnviada,\n      estado_al_notificar: null\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2224,
        160
      ],
      "id": "fee310c1-a682-460c-b06d-c15b3221ac76",
      "name": "Code2"
    },
    {
      "parameters": {
        "jsCode": "// --- Fuentes posibles ---\n  const fromTranscription = $json.userMessage;\n  const fromWebhook = $node[\"Webhook: Recibir WhatsApp\"].json?.body?.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.text?.body;\n\n  // Mensaje final del usuario (nunca null)\n  const userMessage = (fromTranscription ?? fromWebhook ?? \"\").toString().trim();\n\n  // TelÃ©fono\n  const telefono =\n    $json.telefono ??\n    $node[\"Webhook: Recibir WhatsApp\"].json?.body?.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from ??\n    \"\";\n\n  // Base de conocimiento\n  const knowledgeBase =\n    $node[\"HTTP Request (GitHub)\"].json?.data ??\n    $node[\"HTTP Request (GitHub)\"].json ??\n    $json.knowledgeBase ?? \"\";\n\n  // SUPABASE: Manejar respuesta (array o undefined)\n  let leadData = {};\n\n  try {\n    const supabaseResponse = $node[\"Supabase - Get Lead\"].json;\n\n    // Supabase siempre devuelve array\n    if (Array.isArray(supabaseResponse) && supabaseResponse.length > 0) {\n      leadData = supabaseResponse[0];\n    } else if (supabaseResponse && !Array.isArray(supabaseResponse)) {\n      // Por si acaso viene como objeto\n      leadData = supabaseResponse;\n    }\n  } catch (e) {\n    // Si falla, leadData queda como objeto vacÃ­o\n    leadData = {};\n  }\n\n  // Datos previos del lead (para preservar informaciÃ³n ya capturada)\n  const nombrePrevio = leadData.nombre || \"\";\n  const rubroPrevio = leadData.rubro || \"\";\n  const horarioPrevio = leadData.horario_visita || \"\";\n  const timestampPrevio = leadData.horario_visita_timestamp || null;\n  const notificacionPreviamenteEnviada = leadData.notificacion_enviada || false;\n\n  // Historial previo\n  const historialPrevio = leadData.historial_conversacion || \"\";\n\n  // Construir historial completo: historialPrevio + mensaje actual del usuario\n  const historialCompleto =\n    (historialPrevio ? historialPrevio + \"\\n\" : \"\") +\n    \"Usuario: \" + userMessage;\n\n  return [{\n    json: {\n      telefono: telefono,\n      userMessage: userMessage,\n      historial: historialCompleto,\n      knowledgeBase: knowledgeBase,\n      nombre_actual: nombrePrevio,\n      rubro_previo: rubroPrevio,\n      horario_previo: horarioPrevio,\n      timestamp_previo: timestampPrevio,\n      notificacion_previamente_enviada: notificacionPreviamenteEnviada,\n    }\n  }]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1952,
        -192
      ],
      "id": "822a12be-0ba0-47fc-90b2-790cd8ad08f7",
      "name": "Code1"
    },
    {
      "parameters": {
        "jsCode": "// --- Lee el mensaje entrante ---\nconst webhookData = $node[\"Webhook: Recibir WhatsApp\"].json;\nconst messageData = webhookData.body.entry[0].changes[0].value.messages[0];\n\n// --- Datos que necesitamos ---\nconst telefono = messageData.from;\nconst mediaId = messageData.audio.id;\n\n// --- Devuelve los campos al flujo ---\nreturn [{\n  json: {\n    telefono,\n    mediaId,\n    isAudio: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3904,
        160
      ],
      "id": "c476af5c-c789-4e81-be77-32fa7916df74",
      "name": "Code - Extract Audio Info"
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.mediaId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3632,
        160
      ],
      "id": "4bb0a9cc-8fda-45ca-b98e-3aa29c55e791",
      "name": "HTTP Request - Get Audio URL",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$json.url}}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": false
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3344,
        160
      ],
      "id": "c21588b2-7f40-49bc-a5c7-1e539cc9869a",
      "name": "HTTP Request - Download Audio",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -3072,
        160
      ],
      "id": "21a86e76-c576-4527-a65b-700539faedc2",
      "name": "OpenAI - Whisper Transcribe",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener el telÃ©fono del primer nodo de audio\nconst telefono = $node[\"Code - Extract Audio Info\"].json.telefono;\n\n// Obtener la transcripciÃ³n de Whisper\nconst transcripcion = $json.text || '';\n\nreturn [{\n  json: {\n    telefono: telefono,\n    userMessage: transcripcion,\n    isAudio: true,\n    body: {\n      entry: [{\n        changes: [{\n          value: {\n            messages: [{\n              from: telefono,\n              text: {\n                body: transcripcion\n              }\n            }]\n          }\n        }]\n      }]\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2848,
        160
      ],
      "id": "154ff8a5-eed9-48c2-ad40-263ab45ed86d",
      "name": "Code - Format Transcription"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferLast"
            }
          },
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2208,
        -192
      ],
      "id": "ac0cc5b9-b0ff-43f7-84f6-73af963ce416",
      "name": "Merge"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Eres un extractor de datos experto. Analiza la conversaciÃ³n y extrae SOLO la informaciÃ³n solicitada.\n\n  DATOS A EXTRAER:\n  1. nombre: El nombre completo de la persona (solo si lo menciona explÃ­citamente)\n  2. rubro: El tipo de negocio, producto o actividad comercial (ej: ferreterÃ­a, bazar, pescado, ropa, textil, frutas, verduras, pollos, carnes, celulares, televisiones, etc.)\n  3. horario_visita: Texto original que mencionÃ³ sobre horario de visita\n  4. horario_visita_fecha: Fecha calculada en formato DD/MM/YYYY\n  5. horario_visita_hora: Hora en formato H:MMam/pm (ejemplo: 3:00pm, 10:00am)\n\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  CONTEXTO TEMPORAL (para cÃ¡lculo de fechas):\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  - Fecha de HOY: {{$now.format('DD/MM/YYYY')}}\n  - DÃ­a de la semana HOY: {{$now.format('dddd')}}\n  - Formato de fecha esperado: DD/MM/YYYY (dÃ­a/mes/aÃ±o)\n  - Timezone: America/Lima (UTC-5)\n  - Idioma: EspaÃ±ol (PerÃº)\n\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  INSTRUCCIONES PARA CALCULAR FECHAS:\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  TÃº eres GPT-4o-mini y eres capaz de razonar sobre fechas. Usa el contexto de \"hoy\" para calcular correctamente:\n\n  FECHAS RELATIVAS:\n  - \"hoy\" â†’ Calcula fecha de hoy\n  - \"maÃ±ana\" â†’ Suma 1 dÃ­a a hoy\n  - \"pasado maÃ±ana\" â†’ Suma 2 dÃ­as a hoy\n  - \"dentro de X dÃ­as\" â†’ Suma X dÃ­as a hoy\n\n  DÃAS DE LA SEMANA:\n  - \"el lunes\", \"prÃ³ximo lunes\", \"el lunes que viene\" â†’ PrÃ³ximo lunes DESPUÃ‰S de hoy\n  - \"martes de la prÃ³xima semana\" â†’ Martes de la semana siguiente a la actual\n  - \"jueves de esta semana\" â†’ Si hoy es antes del jueves, el jueves de esta semana; si ya pasÃ³, el prÃ³ximo jueves\n  - IMPORTANTE: Si hoy es martes y dice \"el martes\", asume que se refiere al prÃ³ximo martes (no hoy)\n\n  FECHAS EXPLÃCITAS:\n  - \"el 20 de octubre\" â†’ 20/10/2025\n  - \"15 de noviembre\" â†’ 15/11/2025\n\n  CALCULA CORRECTAMENTE:\n  - Hoy es {{$now.format('dddd')}} {{$now.format('DD/MM/YYYY')}}\n  - Usa lÃ³gica matemÃ¡tica para sumar dÃ­as y calcular el dÃ­a de la semana correcto\n  - Retorna SIEMPRE en formato DD/MM/YYYY\n\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  INSTRUCCIONES PARA PARSEAR HORAS:\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  FORMATO ESPERADO: H:MMam/pm (ejemplos: 3:00pm, 10:00am, 8:30am)\n\n  CONVERSIONES COMUNES:\n  - \"4 de la tarde\" â†’ 4:00pm\n  - \"10 de la maÃ±ana\" â†’ 10:00am\n  - \"3 y media de la tarde\" â†’ 3:30pm\n  - \"mediodÃ­a\" â†’ 12:00pm\n  - \"8 de la maÃ±ana\" â†’ 8:00am\n\n  CASOS ESPECIALES:\n  - Si dice \"por la maÃ±ana\" SIN hora especÃ­fica â†’ Dejar VACÃO y no tomarlo en cuenta (Victoria preguntarÃ¡)\n  - Si dice \"por la tarde\" SIN hora especÃ­fica â†’ Dejar VACÃO y no tomarlo en cuenta (Victoria preguntarÃ¡)\n  - Si solo menciona fecha sin hora â†’ Dejar horario_visita_hora VACÃO\n  - Si dice \"este fin de semana\" Sin hora y dÃ­a especÃ­fico â†’ Dejar VACÃO y no tomarlo en cuenta (Victoria preguntarÃ¡)\n\n  REGLA CRÃTICA DE VALIDACIÃ“N:\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  ANTES de retornar el JSON, valida:\n\n  1. Si horario_visita_fecha estÃ¡ VACÃO â†’ horario_visita DEBE estar VACÃO tambiÃ©n\n  2. Si horario_visita_hora estÃ¡ VACÃO â†’ horario_visita DEBE estar VACÃO tambiÃ©n\n  3. \"este fin de semana\", \"por la tarde\", \"por la maÃ±ana\", \"cualquier dÃ­a\" â†’ TODOS los campos VACÃOS\n\n  Ejemplos de lo que NO debes capturar:\n  - \"este fin de semana\" â†’ Todo VACÃO\n  - \"por la tarde\" â†’ Todo VACÃO\n  - \"cuando pueda\" â†’ Todo VACÃO\n  - \"cualquier dÃ­a\" â†’ Todo VACÃO\n\n  SOLO captura horario_visita si tienes DÃA ESPECÃFICO (ej: lunes, martes, 15 de octubre)\n\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  REGLAS CRÃTICAS:\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  1. Si NO menciona horario de visita â†’ Todos los campos de horario VACÃOS\n  2. Si menciona dÃ­a pero NO hora especÃ­fica â†’ horario_visita y horario_visita_fecha llenos, horario_visita_hora VACÃO\n  3. Si menciona dÃ­a Y hora especÃ­fica â†’ Todos los campos llenos\n  4. NO inventes informaciÃ³n que no estÃ¡ en el mensaje\n  5. NO repitas datos de mensajes anteriores si no se mencionan en el actual\n  6. Si solo saluda â†’ Todos los campos VACÃOS\n  7. SIEMPRE calcula fechas basÃ¡ndote en HOY ({{$now.format('DD/MM/YYYY')}})\n  8. ConfÃ­a en tu capacidad de razonamiento temporal (eres GPT-4o-mini)\n  9. Si no tienes claro el dÃ­a y hora de visita â†’ Todos los campos de horario VACÃOS (Victoria pregutnarÃ¡)\n\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  EJEMPLOS (HOY es {{$now.format('dddd')}} {{$now.format('DD/MM/YYYY')}}):\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n  Ejemplo 1:\n  Usuario: \"el prÃ³ximo jueves a las 4 de la tarde\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"el prÃ³ximo jueves a las 4 de la tarde\",\n    \"horario_visita_fecha\": \"16/10/2025\",\n    \"horario_visita_hora\": \"4:00pm\"\n  }\n\n  Ejemplo 2:\n  Usuario: \"martes de la prÃ³xima semana\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"martes de la prÃ³xima semana\",\n    \"horario_visita_fecha\": \"21/10/2025\",\n    \"horario_visita_hora\": \"\"\n  }\n\n  Ejemplo 3:\n  Usuario: \"maÃ±ana por la maÃ±ana\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"maÃ±ana por la maÃ±ana\",\n    \"horario_visita_fecha\": \"15/10/2025\",\n    \"horario_visita_hora\": \"\"\n  }\n\n  Ejemplo 4:\n  Usuario: \"dentro de 5 dÃ­as a las 10am\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"dentro de 5 dÃ­as a las 10am\",\n    \"horario_visita_fecha\": \"19/10/2025\",\n    \"horario_visita_hora\": \"10:00am\"\n  }\n\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  FORMATO DE RESPUESTA (JSON estricto):\n  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"\",\n    \"horario_visita_fecha\": \"\",\n    \"horario_visita_hora\": \"\"\n  }",
              "role": "system"
            },
            {
              "content": "=CONVERSACIÃ“N COMPLETA:\n{{ $node[\"Code1\"].json.historial }}\n\nMENSAJE ACTUAL DEL USUARIO:\n{{ $node[\"Code1\"].json.userMessage }}\n\nDATOS PREVIAMENTE CAPTURADOS:\n- Nombre anterior: {{ $node[\"Code1\"].json.nombre_actual || \"ninguno\" }}\n- Rubro anterior: {{ $node[\"Code1\"].json.rubro_previo || \"ninguno\" }}\n- Horario anterior: {{ $node[\"Code1\"].json.horario_previo || \"ninguno\" }}\n\nExtrae SOLO nueva informaciÃ³n del mensaje actual. Si no hay datos nuevos, devuelve campos vacÃ­os."
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -1616,
        -96
      ],
      "id": "aa51a481-3dbc-42d5-a82f-07a9d259d8bd",
      "name": "OpenAI - Extract Data",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get extracted data from OpenAI\n  const extractedRaw = $json?.message?.content;\n  let extracted = { horario_visita_fecha: \"\", horario_visita_hora: \"\" };\n\n  try {\n    if (typeof extractedRaw === \"string\") {\n      extracted = JSON.parse(extractedRaw);\n    } else if (typeof extractedRaw === \"object\" && extractedRaw) {\n      extracted = extractedRaw;\n    }\n  } catch (e) {\n    // Si falla el parsing, devuelve null\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  const fecha = (extracted.horario_visita_fecha || \"\").trim();\n  const hora = (extracted.horario_visita_hora || \"\").trim();\n\n  // Si no hay fecha O no hay hora, timestamp es null\n  if (!fecha || !hora) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  // Parse fecha DD/MM/YYYY\n  const parts = fecha.split('/');\n  if (parts.length !== 3) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  const day = parseInt(parts[0], 10);\n  const month = parseInt(parts[1], 10);\n  const year = parseInt(parts[2], 10);\n\n  // Validate date components\n  if (!day || !month || !year || month < 1 || month > 12 || day < 1 || day > 31) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  // Parse hora H:MMam/pm or HH:MMam/pm\n  const horaMatch = hora.match(/^(\\d{1,2}):(\\d{2})\\s*(am|pm)$/i);\n  if (!horaMatch) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  let hours = parseInt(horaMatch[1], 10);\n  const minutes = parseInt(horaMatch[2], 10);\n  const ampm = horaMatch[3].toLowerCase();\n\n  // Convert to 24-hour format\n  if (ampm === 'pm' && hours !== 12) {\n    hours += 12;\n  } else if (ampm === 'am' && hours === 12) {\n    hours = 0;\n  }\n\n  // âœ… FIX CRÃTICO: Crear ISO string con timezone EXPLÃCITO de Lima (-05:00)\n  try {\n    // Construir string ISO con offset de Lima\n    const limaDateString = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2,\n  '0')}T${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00-05:00`;\n\n    // JavaScript Date convierte automÃ¡ticamente a UTC\n    const dateObj = new Date(limaDateString);\n\n    // Validar que la fecha es vÃ¡lida\n    if (isNaN(dateObj.getTime())) {\n      return [{ json: { horario_visita_timestamp: null } }];\n    }\n\n    // Retornar ISO string en UTC (ya convertido correctamente)\n    return [{ json: { horario_visita_timestamp: dateObj.toISOString() } }];\n\n  } catch (e) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1824,
        -32
      ],
      "id": "5a31b4ac-792e-44a8-a1b5-7688142f21e9",
      "name": "Parse Horario to Timestamp"
    },
    {
      "parameters": {
        "url": "https://raw.githubusercontent.com/iterruptivo/ecoplaza-agente-ia/refs/heads/main/ecoplaza-instrucciones-agente.txt",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2864,
        -208
      ],
      "id": "530f1bd4-85e0-4b41-992c-4256c6b0e9d7",
      "name": "HTTP Request (GitHub)",
      "credentials": {
        "httpHeaderAuth": {
          "id": "ilMGirJWHVtqUPrH",
          "name": "Header Auth account (githup)"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $json.message_id }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3152,
        -208
      ],
      "id": "0419efa7-b81e-4789-bb1e-94c59b6b04cc",
      "name": "HTTP Request - Mark Message as Read",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const v = $json.body.entry[0].changes[0].value;\nconst telefono = v.messages[0].from;\n\nreturn [{\n  json: {\n    phone_number_id: v.metadata.phone_number_id,\n    message_id: v.messages[0].id,\n    telefono: telefono,\n    body: $json.body\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3472,
        -208
      ],
      "id": "d313a8ae-62cb-4142-bdab-eb96da075e5d",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "Eres un asistente que resume conversaciones de WhatsApp para CRM.\nDevuelve SOLO un JSON vÃ¡lido con:\n{\n  \"resumen_historial\": string\n}\nReglas:\n- \"resumen_historial\": sÃ­ntesis clara y fiel de TODO el historial (sin inventar).\n- No incluyas comentarios; solo JSON vÃ¡lido.",
              "role": "system"
            },
            {
              "content": "=HISTORIAL COMPLETO:\n{{ $json.historial_conversacion || '' }}"
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2272,
        336
      ],
      "id": "5e7f87d6-8cbe-4129-a90b-609739db2b31",
      "name": "OpenAI Summarize History",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1",
              "overrideEmpty": true
            }
          },
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1520,
        208
      ],
      "id": "4d083521-98fd-45cb-a72e-917b9c00889b",
      "name": "Merge1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ea392d8-056e-48f8-ae01-4d9bd10de00a",
              "name": "resumen_historial",
              "value": "={{ $json.message?.content?.resumen_historial || $json.resumen_historial || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1760,
        304
      ],
      "id": "e64561c1-8018-4720-a2b3-473860a5cd3b",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "81984b69-9b4d-4bf1-8e5e-9caaa32c34bf",
              "leftValue": "={{ $json.estado }}",
              "rightValue": "=en_conversacion",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
              "leftValue": "={{ $json.notificacion_enviada.toString() }}",
              "rightValue": "=false",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1344,
        144
      ],
      "id": "16d9e71b-a076-40f5-a3fe-8629cbb06b8d",
      "name": "IF - Conversacion Cerrada?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/757095820830409/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.vendor_phone }}\",\n  \"text\": {\n    \"body\": \"{{ $json.notification_message }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        -352
      ],
      "id": "70237e71-47a8-43b7-a9b5-d975ca67a8eb",
      "name": "WhatsApp - Send Vendor Notification",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": " // Obtener datos del lead desde Code2\n  const leadData = $node[\"Code2\"]?.json || {};\n\n  // Capturar estado SOLO si es la primera notificaciÃ³n\n  const estado_al_notificar = leadData.notificacion_enviada === false\n    ? leadData.estado\n    : leadData.estado_al_notificar;\n\n  // Marcar como notificado\n  return [{\n    json: {\n      ...leadData,\n      notificacion_enviada: true,\n      estado_al_notificar: estado_al_notificar\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        -48
      ],
      "id": "ae58220c-04fb-4fc4-8c71-b33703050fc0",
      "name": "Code - Get First Item"
    },
    {
      "parameters": {
        "jsCode": "// === 1) Lead desde el nodo \"IF - Conversacion Cerrada?\" ===\nconst leadItem = $items(\"IF - Conversacion Cerrada?\", 0, 0);\nconst leadData = leadItem?.json || {};\n\n// Obtener el estado desde Code2 (es la fuente mÃ¡s confiable)\nconst estado = leadData.estado || $node[\"Code2\"]?.json?.estado || \"en_conversacion\";\n\n// === 2) Vendedores ===\nconst vendedores = $input.all();\n\n// === 3) Formatear estado y mensaje ===\nconst estadoUpper = estado.toUpperCase().replace(/_/g, \" \");\nconst mensaje = `Nuevo Lead Proyecto Trapiche - Estado: ${estadoUpper}`;\n\n// === 4) Crear items por vendedor ===\nreturn vendedores\n  .map(v => v?.json)\n  .filter(v => v && v.telefono)\n  .map(v => ({\n    json: {\n      vendor_phone: v.telefono,\n      vendor_name: v.nombre,\n      notification_message: mensaje,\n      ...leadData,\n    },\n  }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        -368
      ],
      "id": "52967a01-7a94-479b-92a8-0776cf1ddb92",
      "name": "Code - Format Vendor Notifications"
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -144,
        -368
      ],
      "id": "51328b7b-cb58-4d82-8a68-ea223cd7911d",
      "name": "Split In Batches - Vendors"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -80,
        -32
      ],
      "id": "bfe6e453-1405-4c29-a501-30732313ab18",
      "name": "Wait",
      "webhookId": "a702250c-f1cb-4da2-bc31-3dc863758037"
    },
    {
      "parameters": {
        "url": "=https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/leads?telefono=eq.{{ $node[\"Webhook: Recibir WhatsApp\"].json.body.entry[0].changes[0].value.messages[0].from }}&select=*",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2576,
        -208
      ],
      "id": "0b067b88-002f-4248-b73d-cc092f76a5e9",
      "name": "Supabase - Get Lead",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "telefono",
              "value": "={{ $json.telefono }}"
            },
            {
              "name": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "name": "rubro",
              "value": "={{ $json.rubro }}"
            },
            {
              "name": "horario_visita",
              "value": "={{ $json.horario_visita }}"
            },
            {
              "name": "horario_visita_timestamp",
              "value": "={{ $json.horario_visita_timestamp }}"
            },
            {
              "name": "estado",
              "value": "={{ $json.estado }}"
            },
            {
              "name": "historial_conversacion",
              "value": "={{ $json.historial_conversacion }}"
            },
            {
              "name": "historial_reciente",
              "value": "={{ $json.historial_reciente }}"
            },
            {
              "name": "resumen_historial",
              "value": "={{ $json.resumen_historial }}"
            },
            {
              "name": "ultimo_mensaje",
              "value": "={{ $json.ultimo_mensaje }}"
            },
            {
              "name": "intentos_bot",
              "value": "={{ $json.intentos_bot }}"
            },
            {
              "name": "fecha_captura",
              "value": "={{ $json.fecha_captura }}"
            },
            {
              "name": "notificacion_enviada",
              "value": "={{ $json.notificacion_enviada }}"
            },
            {
              "name": "estado_al_notificar",
              "value": "={{$json.estado_al_notificar}}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -528,
        288
      ],
      "id": "be074270-cdf1-4760-ac39-d996014e5670",
      "name": "Supabase - Upsert Lead"
    },
    {
      "parameters": {
        "url": "https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/vendedores?activo=eq.true&select=*",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -544,
        -368
      ],
      "id": "ab2550c7-4272-40f2-9c1f-0a016648f08f",
      "name": "Supabase - Get Vendedores"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "62b93104-2e80-460f-9646-337343ff3daa",
              "leftValue": "={{ !$json.notificacion_enviada }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -960,
        -144
      ],
      "id": "50110abe-4407-4254-a482-d442587173ee",
      "name": "If1"
    },
    {
      "parameters": {
        "url": "=https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/leads?telefono=eq.{{ $json.telefono }}&select=*",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1216,
        -144
      ],
      "id": "4af0e471-e61f-4621-94e8-52fe542d8bdf",
      "name": "Supabase - Get Lead1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "5pHMC1T78XfLbQ81",
          "name": "Supabase API Key"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook: Recibir WhatsApp": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code - Extract Audio Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "OpenAI - Extract Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "OpenAI Summarize History",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Extract Audio Info": {
      "main": [
        [
          {
            "node": "HTTP Request - Get Audio URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Get Audio URL": {
      "main": [
        [
          {
            "node": "HTTP Request - Download Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Download Audio": {
      "main": [
        [
          {
            "node": "OpenAI - Whisper Transcribe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Whisper Transcribe": {
      "main": [
        [
          {
            "node": "Code - Format Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Format Transcription": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Extract Data": {
      "main": [
        [
          {
            "node": "Parse Horario to Timestamp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Horario to Timestamp": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request (GitHub)": {
      "main": [
        [
          {
            "node": "Supabase - Get Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Mark Message as Read": {
      "main": [
        [
          {
            "node": "HTTP Request (GitHub)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request - Mark Message as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Summarize History": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "IF - Conversacion Cerrada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "IF - Conversacion Cerrada?": {
      "main": [
        [
          {
            "node": "Supabase - Get Lead1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase - Upsert Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp - Send Vendor Notification": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Get First Item": {
      "main": [
        [
          {
            "node": "Supabase - Upsert Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Format Vendor Notifications": {
      "main": [
        [
          {
            "node": "Split In Batches - Vendors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches - Vendors": {
      "main": [
        [
          {
            "node": "Code - Get First Item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WhatsApp - Send Vendor Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Split In Batches - Vendors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Lead": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Upsert Lead": {
      "main": [
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Vendedores": {
      "main": [
        [
          {
            "node": "Code - Format Vendor Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Supabase - Get Vendedores",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase - Upsert Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Lead1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "087614cf-ec02-40e0-ac63-7f65db70c287",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ac495b013a9dddb9724430276f2a1ebc03086cb4690790d0c3f0b57736633d28"
  },
  "id": "EFm0520weXRlELzc",
  "tags": [
    {
      "createdAt": "2025-10-05T15:49:21.676Z",
      "updatedAt": "2025-10-05T15:49:21.676Z",
      "id": "kW6ZhQEWOP50a5HL",
      "name": "IA Agent Bot"
    }
  ]
}