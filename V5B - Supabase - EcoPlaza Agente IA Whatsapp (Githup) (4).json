{
  "name": "V5B - Supabase - EcoPlaza Agente IA Whatsapp (Githup)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-eco",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -5264,
        -16
      ],
      "id": "79b458e4-375c-46ba-9190-6da5807b79db",
      "name": "Webhook: Recibir WhatsApp",
      "webhookId": "cce6941e-eeff-40ab-98de-c3e5e549d25d"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query[\"hub.challenge\"] }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -4592,
        -208
      ],
      "id": "2fc1a6af-f6a4-4aa1-96ce-2381213da403",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "dbcc75b1-9deb-49c4-8f55-34b8d3c23455"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0d57ef7c-87b7-44a5-9374-4082c3398cac",
                    "leftValue": "={{ $json.body[\"hub.mode\"] }}",
                    "rightValue": "subscribe",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "verification"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d9c90a3f-fc16-4e84-bebb-2c87048cd4f1",
                    "leftValue": "={{ $json.body.entry[0].changes[0].value.messages[0].type }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -4848,
        -32
      ],
      "id": "88cb6fb1-d1ec-4188-afaa-f6f2c36a87e7",
      "name": "Switch"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=--- DOCUMENTO (fuente de verdad, no inventes nada) ---\n{{ $json.knowledgeBase || '' }}\n--- FIN ---\n\nINFORMACIÓN DEL USUARIO:\n{{ $json.nombre_actual ? \"Nombre: \" + $json.nombre_actual : \"Aún no ha proporcionado su nombre\" }}\n\nHISTORIAL DE CONVERSACIÓN:\n{{ $json.historial || '' }}\n\nINSTRUCCIÓN IMPORTANTE: Si ya conoces el nombre del usuario, NO vuelvas a pedirlo. NO te presentes de nuevo si ya iniciaste la conversación antes. Continúa naturalmente la conversación.",
              "role": "system"
            },
            {
              "content": "={{ $json.userMessage || '' }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2752,
        -160
      ],
      "id": "4cb0c18c-e6b5-4e3a-a3cc-918ac34b1caa",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "859011830622528",
        "recipientPhoneNumber": "={{ $node[\"Webhook: Recibir WhatsApp\"].json.body.entry[0].changes[0].value.contacts[0].wa_id }}\n",
        "textBody": "={{ $node[\"Code2\"].json.mensaje_bot_final }}",
        "additionalFields": {
          "previewUrl": false
        }
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -384,
        336
      ],
      "id": "5dd63ca1-c3bc-4f8f-bc9a-d1433768f871",
      "name": "Send message",
      "webhookId": "7c64d128-f027-442b-90aa-873b0054d6b0",
      "credentials": {
        "whatsAppApi": {
          "id": "MaqucdVEXd2ZnLlT",
          "name": "WhatsApp account (Business - iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c1313a0d-5d8f-497f-a0d5-7dc9aeadf3e2",
              "leftValue": "=={{ $json.query['hub.mode'] }}",
              "rightValue": "subscribe",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5056,
        -192
      ],
      "id": "5302d296-ead1-4b15-9305-c8af32f0ab1a",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Entradas\n  const botResponse = $node[\"Message a model\"].json?.message?.content || \"\";\n  const telefono = $node[\"Code1\"].json.telefono || \"\";\n  const historialPrevio = $node[\"Code1\"].json.historial || \"\";\n  const userMessage = $node[\"Code1\"].json.userMessage || \"\";\n\n  const nombrePrevio = $node[\"Code1\"].json.nombre_actual || \"\";\n  const rubroPrevio = $node[\"Code1\"].json.rubro_previo || \"\";\n  const horarioPrevio = $node[\"Code1\"].json.horario_previo || \"\";\n\n  // Datos extraídos por GPT\n  const extractedRaw = $node[\"OpenAI - Extract Data\"].json?.message?.content;\n  let extracted = { nombre: \"\", rubro: \"\", horario_visita: \"\", horario_visita_fecha: \"\", horario_visita_hora: \"\"\n  };\n  try {\n    if (typeof extractedRaw === \"string\") extracted = JSON.parse(extractedRaw);\n    else if (typeof extractedRaw === \"object\" && extractedRaw) extracted = extractedRaw;\n  } catch (e) { /* default */ }\n\n  const nombre = (extracted.nombre || \"\").trim() || nombrePrevio;\n  const rubro = (extracted.rubro || \"\").trim() || rubroPrevio;\n  const horario = (extracted.horario_visita || \"\").trim() || horarioPrevio;\n\n  // ═══════════════════════════════════════════════════════════\n  // TIMESTAMP PRESERVATION LOGIC (NUEVO)\n  // ═══════════════════════════════════════════════════════════\n\n  // Leer nuevo timestamp del parser\n  const nuevoTimestamp = $node[\"Parse Horario to Timestamp\"].json?.horario_visita_timestamp || null;\n\n  // Leer timestamp anterior de la BD (vía Code1)\n  const timestampPrevio = $node[\"Code1\"].json.timestamp_previo || null;\n\n  // PRESERVAR: Si nuevo es null, mantener el anterior\n  // Si nuevo NO es null, usar el nuevo (permite actualizar si usuario cambia horario)\n  const horario_visita_timestamp = nuevoTimestamp !== null ? nuevoTimestamp : timestampPrevio;\n\n  // ═══════════════════════════════════════════════════════════\n\n  // Contar intentos\n  const noaMessages = (historialPrevio.match(/\\nAgenteIA:/g) || []).length;\n\n  let estado = \"en_conversacion\";\n  let debeForazarCierre = false;\n\n  // ---- LÓGICA INTELIGENTE DE ESTADOS ----\n\n  // 1. Si tiene TODOS los datos → Lead completo (puede seguir preguntando)\n  if (nombre && rubro && horario) {\n    estado = \"lead_completo\";\n    debeForazarCierre = false;  // NUNCA forzar cierre si tiene datos completos\n  }\n  // 2. Si tiene ALGUNOS datos (parcial)\n  else if (nombre || rubro || horario) {\n    // Dar más oportunidades (15 intentos) porque muestra interés\n    if (noaMessages >= 15) {\n      estado = \"lead_incompleto\";\n      debeForazarCierre = true;\n    } else {\n      estado = \"en_conversacion\";\n      debeForazarCierre = false;\n    }\n  }\n  // 3. Si NO tiene NINGÚN dato\n  else {\n    // Cerrar antes (10 intentos) porque no muestra interés real\n    if (noaMessages >= 10) {\n      estado = \"conversacion_abandonada\";\n      debeForazarCierre = true;\n    } else {\n      estado = \"en_conversacion\";\n      debeForazarCierre = false;\n    }\n  }\n\n  // ---- MENSAJE FINAL ----\n  let mensajeBot = botResponse;\n\n  // Solo forzar cierre si corresponde\n  if (debeForazarCierre) {\n    mensajeBot = \"Su caso es importante para nosotros, pronto un asesor especializado se comunicará con usted para atender sus consultas de forma detallada, manténgase al pendiente por favor. 🤗\";\n  }\n\n  // Construir historial completo (NO duplicar mensaje de usuario, ya está en historialPrevio)\n  const historial_conversacion =\n    (historialPrevio ? historialPrevio + \"\\n\" : \"\") +\n    \"AgenteIA: \" + mensajeBot;\n\n  // Últimos 10 mensajes\n  const lines = historial_conversacion.split(/\\r?\\n/).filter(Boolean);\n  const historial_reciente = lines.slice(-10).join(\"\\n\");\n\n  return [{\n    json: {\n      telefono: telefono,\n      nombre: nombre,\n      rubro: rubro,\n      horario_visita: horario,\n      horario_visita_timestamp: horario_visita_timestamp, // ← AHORA PRESERVADO\n      historial_conversacion,\n      historial_reciente,\n      fecha_captura: new Date().toISOString(),\n      ultimo_mensaje: userMessage,\n      estado: estado,\n      intentos_bot: noaMessages + 1,\n      mensaje_bot_final: mensajeBot,\n      notificacion_enviada: false,\n      estado_al_notificar: null\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3344,
        320
      ],
      "id": "6115a001-95cc-4583-9831-7039a852b4d6",
      "name": "Code2"
    },
    {
      "parameters": {
        "jsCode": "// --- Fuentes posibles ---\n  const fromTranscription = $json.userMessage;\n  const fromWebhook = $node[\"Webhook: Recibir WhatsApp\"].json?.body?.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.text?.body;\n\n  // Mensaje final del usuario (nunca null)\n  const userMessage = (fromTranscription ?? fromWebhook ?? \"\").toString().trim();\n\n  // Teléfono\n  const telefono =\n    $json.telefono ??\n    $node[\"Webhook: Recibir WhatsApp\"].json?.body?.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from ??\n    \"\";\n\n  // Base de conocimiento\n  const knowledgeBase =\n    $node[\"HTTP Request (GitHub)\"].json?.data ??\n    $node[\"HTTP Request (GitHub)\"].json ??\n    $json.knowledgeBase ?? \"\";\n\n  // SUPABASE: Manejar respuesta (array o undefined)\n  let leadData = {};\n\n  try {\n    const supabaseResponse = $node[\"Supabase - Get Lead\"].json;\n\n    // Supabase siempre devuelve array\n    if (Array.isArray(supabaseResponse) && supabaseResponse.length > 0) {\n      leadData = supabaseResponse[0];\n    } else if (supabaseResponse && !Array.isArray(supabaseResponse)) {\n      // Por si acaso viene como objeto\n      leadData = supabaseResponse;\n    }\n  } catch (e) {\n    // Si falla, leadData queda como objeto vacío\n    leadData = {};\n  }\n\n  // Datos previos del lead (para preservar información ya capturada)\n  const nombrePrevio = leadData.nombre || \"\";\n  const rubroPrevio = leadData.rubro || \"\";\n  const horarioPrevio = leadData.horario_visita || \"\";\n  const timestampPrevio = leadData.horario_visita_timestamp || null; // ← NUEVO: Preservar timestamp\n\n  // Historial previo\n  const historialPrevio = leadData.historial_conversacion || \"\";\n\n  // Construir historial completo: historialPrevio + mensaje actual del usuario\n  const historialCompleto =\n    (historialPrevio ? historialPrevio + \"\\n\" : \"\") +\n    \"Usuario: \" + userMessage;\n\n  return [{\n    json: {\n      telefono: telefono,\n      userMessage: userMessage,\n      historial: historialCompleto,\n      knowledgeBase: knowledgeBase,\n      nombre_actual: nombrePrevio,\n      rubro_previo: rubroPrevio,\n      horario_previo: horarioPrevio,\n      timestamp_previo: timestampPrevio, // ← NUEVO: Pasar timestamp al siguiente nodo\n    }\n  }]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3072,
        -32
      ],
      "id": "647bb718-9ea6-47f5-bc47-175fd6571c06",
      "name": "Code1"
    },
    {
      "parameters": {
        "jsCode": "// --- Lee el mensaje entrante ---\nconst webhookData = $node[\"Webhook: Recibir WhatsApp\"].json;\nconst messageData = webhookData.body.entry[0].changes[0].value.messages[0];\n\n// --- Datos que necesitamos ---\nconst telefono = messageData.from;\nconst mediaId = messageData.audio.id;\n\n// --- Devuelve los campos al flujo ---\nreturn [{\n  json: {\n    telefono,\n    mediaId,\n    isAudio: true\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5024,
        320
      ],
      "id": "c607d1c6-b2bc-4be3-b6a5-c4d7b6aeef98",
      "name": "Code - Extract Audio Info"
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v21.0/{{ $json.mediaId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4752,
        320
      ],
      "id": "afd4009a-6c1c-409e-bd9d-b687b4b8ecd2",
      "name": "HTTP Request - Get Audio URL",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$json.url}}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": false
            }
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4464,
        320
      ],
      "id": "b53f3992-b163-4ea8-96c3-6a1a4f6c27a7",
      "name": "HTTP Request - Download Audio",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -4192,
        320
      ],
      "id": "d89be571-4617-465e-8075-3af9e515af98",
      "name": "OpenAI - Whisper Transcribe",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obtener el teléfono del primer nodo de audio\nconst telefono = $node[\"Code - Extract Audio Info\"].json.telefono;\n\n// Obtener la transcripción de Whisper\nconst transcripcion = $json.text || '';\n\nreturn [{\n  json: {\n    telefono: telefono,\n    userMessage: transcripcion,\n    isAudio: true,\n    body: {\n      entry: [{\n        changes: [{\n          value: {\n            messages: [{\n              from: telefono,\n              text: {\n                body: transcripcion\n              }\n            }]\n          }\n        }]\n      }]\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3968,
        320
      ],
      "id": "4ddf4294-1a9d-4bec-934f-8a11a9c49ea3",
      "name": "Code - Format Transcription"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferLast"
            }
          },
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -3328,
        -32
      ],
      "id": "b2892080-6a19-4161-8fe2-07fc06b7ac8d",
      "name": "Merge"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "=Eres un extractor de datos experto. Analiza la conversación y extrae SOLO la información solicitada.\n\n  DATOS A EXTRAER:\n  1. nombre: El nombre completo de la persona (solo si lo menciona explícitamente)\n  2. rubro: El tipo de negocio, producto o actividad comercial (ej: ferretería, bazar, pescado, ropa, textil, frutas, verduras, pollos, carnes, celulares, televisiones, etc.)\n  3. horario_visita: Texto original que mencionó sobre horario de visita\n  4. horario_visita_fecha: Fecha calculada en formato DD/MM/YYYY\n  5. horario_visita_hora: Hora en formato H:MMam/pm (ejemplo: 3:00pm, 10:00am)\n\n  ═══════════════════════════════════════════════════════\n  CONTEXTO TEMPORAL (para cálculo de fechas):\n  ═══════════════════════════════════════════════════════\n  - Fecha de HOY: {{$now.format('DD/MM/YYYY')}}\n  - Día de la semana HOY: {{$now.format('dddd')}}\n  - Formato de fecha esperado: DD/MM/YYYY (día/mes/año)\n  - Timezone: America/Lima (UTC-5)\n  - Idioma: Español (Perú)\n\n  ═══════════════════════════════════════════════════════\n  INSTRUCCIONES PARA CALCULAR FECHAS:\n  ═══════════════════════════════════════════════════════\n\n  Tú eres GPT-4o-mini y eres capaz de razonar sobre fechas. Usa el contexto de \"hoy\" para calcular correctamente:\n\n  FECHAS RELATIVAS:\n  - \"hoy\" → Calcula fecha de hoy\n  - \"mañana\" → Suma 1 día a hoy\n  - \"pasado mañana\" → Suma 2 días a hoy\n  - \"dentro de X días\" → Suma X días a hoy\n\n  DÍAS DE LA SEMANA:\n  - \"el lunes\", \"próximo lunes\", \"el lunes que viene\" → Próximo lunes DESPUÉS de hoy\n  - \"martes de la próxima semana\" → Martes de la semana siguiente a la actual\n  - \"jueves de esta semana\" → Si hoy es antes del jueves, el jueves de esta semana; si ya pasó, el próximo jueves\n  - IMPORTANTE: Si hoy es martes y dice \"el martes\", asume que se refiere al próximo martes (no hoy)\n\n  FECHAS EXPLÍCITAS:\n  - \"el 20 de octubre\" → 20/10/2025\n  - \"15 de noviembre\" → 15/11/2025\n\n  CALCULA CORRECTAMENTE:\n  - Hoy es {{$now.format('dddd')}} {{$now.format('DD/MM/YYYY')}}\n  - Usa lógica matemática para sumar días y calcular el día de la semana correcto\n  - Retorna SIEMPRE en formato DD/MM/YYYY\n\n  ═══════════════════════════════════════════════════════\n  INSTRUCCIONES PARA PARSEAR HORAS:\n  ═══════════════════════════════════════════════════════\n\n  FORMATO ESPERADO: H:MMam/pm (ejemplos: 3:00pm, 10:00am, 8:30am)\n\n  CONVERSIONES COMUNES:\n  - \"4 de la tarde\" → 4:00pm\n  - \"10 de la mañana\" → 10:00am\n  - \"3 y media de la tarde\" → 3:30pm\n  - \"mediodía\" → 12:00pm\n  - \"8 de la mañana\" → 8:00am\n\n  CASOS ESPECIALES:\n  - Si dice \"por la mañana\" SIN hora específica → Dejar VACÍO y no tomarlo en cuenta (Victoria preguntará)\n  - Si dice \"por la tarde\" SIN hora específica → Dejar VACÍO y no tomarlo en cuenta (Victoria preguntará)\n  - Si solo menciona fecha sin hora → Dejar horario_visita_hora VACÍO\n  - Si dice \"este fin de semana\" Sin hora y día específico → Dejar VACÍO y no tomarlo en cuenta (Victoria preguntará)\n\n  REGLA CRÍTICA DE VALIDACIÓN:\n  ═══════════════════════════════════════════════════════════\n  ANTES de retornar el JSON, valida:\n\n  1. Si horario_visita_fecha está VACÍO → horario_visita DEBE estar VACÍO también\n  2. Si horario_visita_hora está VACÍO → horario_visita DEBE estar VACÍO también\n  3. \"este fin de semana\", \"por la tarde\", \"por la mañana\", \"cualquier día\" → TODOS los campos VACÍOS\n\n  Ejemplos de lo que NO debes capturar:\n  - \"este fin de semana\" → Todo VACÍO\n  - \"por la tarde\" → Todo VACÍO\n  - \"cuando pueda\" → Todo VACÍO\n  - \"cualquier día\" → Todo VACÍO\n\n  SOLO captura horario_visita si tienes DÍA ESPECÍFICO (ej: lunes, martes, 15 de octubre)\n\n  ═══════════════════════════════════════════════════════\n  REGLAS CRÍTICAS:\n  ═══════════════════════════════════════════════════════\n\n  1. Si NO menciona horario de visita → Todos los campos de horario VACÍOS\n  2. Si menciona día pero NO hora específica → horario_visita y horario_visita_fecha llenos, horario_visita_hora VACÍO\n  3. Si menciona día Y hora específica → Todos los campos llenos\n  4. NO inventes información que no está en el mensaje\n  5. NO repitas datos de mensajes anteriores si no se mencionan en el actual\n  6. Si solo saluda → Todos los campos VACÍOS\n  7. SIEMPRE calcula fechas basándote en HOY ({{$now.format('DD/MM/YYYY')}})\n  8. Confía en tu capacidad de razonamiento temporal (eres GPT-4o-mini)\n  9. Si no tienes claro el día y hora de visita → Todos los campos de horario VACÍOS (Victoria pregutnará)\n\n  ═══════════════════════════════════════════════════════\n  EJEMPLOS (HOY es {{$now.format('dddd')}} {{$now.format('DD/MM/YYYY')}}):\n  ═══════════════════════════════════════════════════════\n\n  Ejemplo 1:\n  Usuario: \"el próximo jueves a las 4 de la tarde\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"el próximo jueves a las 4 de la tarde\",\n    \"horario_visita_fecha\": \"16/10/2025\",\n    \"horario_visita_hora\": \"4:00pm\"\n  }\n\n  Ejemplo 2:\n  Usuario: \"martes de la próxima semana\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"martes de la próxima semana\",\n    \"horario_visita_fecha\": \"21/10/2025\",\n    \"horario_visita_hora\": \"\"\n  }\n\n  Ejemplo 3:\n  Usuario: \"mañana por la mañana\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"mañana por la mañana\",\n    \"horario_visita_fecha\": \"15/10/2025\",\n    \"horario_visita_hora\": \"\"\n  }\n\n  Ejemplo 4:\n  Usuario: \"dentro de 5 días a las 10am\"\n  Respuesta:\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"dentro de 5 días a las 10am\",\n    \"horario_visita_fecha\": \"19/10/2025\",\n    \"horario_visita_hora\": \"10:00am\"\n  }\n\n  ═══════════════════════════════════════════════════════\n  FORMATO DE RESPUESTA (JSON estricto):\n  ═══════════════════════════════════════════════════════\n  {\n    \"nombre\": \"\",\n    \"rubro\": \"\",\n    \"horario_visita\": \"\",\n    \"horario_visita_fecha\": \"\",\n    \"horario_visita_hora\": \"\"\n  }",
              "role": "system"
            },
            {
              "content": "=CONVERSACIÓN COMPLETA:\n{{ $node[\"Code1\"].json.historial }}\n\nMENSAJE ACTUAL DEL USUARIO:\n{{ $node[\"Code1\"].json.userMessage }}\n\nDATOS PREVIAMENTE CAPTURADOS:\n- Nombre anterior: {{ $node[\"Code1\"].json.nombre_actual || \"ninguno\" }}\n- Rubro anterior: {{ $node[\"Code1\"].json.rubro_previo || \"ninguno\" }}\n- Horario anterior: {{ $node[\"Code1\"].json.horario_previo || \"ninguno\" }}\n\nExtrae SOLO nueva información del mensaje actual. Si no hay datos nuevos, devuelve campos vacíos."
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -2736,
        64
      ],
      "id": "f0814bde-48d8-4f1e-ac19-9a8fb9606ddf",
      "name": "OpenAI - Extract Data",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get extracted data from OpenAI\n  const extractedRaw = $json?.message?.content;\n  let extracted = { horario_visita_fecha: \"\", horario_visita_hora: \"\" };\n\n  try {\n    if (typeof extractedRaw === \"string\") {\n      extracted = JSON.parse(extractedRaw);\n    } else if (typeof extractedRaw === \"object\" && extractedRaw) {\n      extracted = extractedRaw;\n    }\n  } catch (e) {\n    // Si falla el parsing, devuelve null\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  const fecha = (extracted.horario_visita_fecha || \"\").trim();\n  const hora = (extracted.horario_visita_hora || \"\").trim();\n\n  // Si no hay fecha O no hay hora, timestamp es null\n  if (!fecha || !hora) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  // Parse fecha DD/MM/YYYY\n  const parts = fecha.split('/');\n  if (parts.length !== 3) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  const day = parseInt(parts[0], 10);\n  const month = parseInt(parts[1], 10);\n  const year = parseInt(parts[2], 10);\n\n  // Validate date components\n  if (!day || !month || !year || month < 1 || month > 12 || day < 1 || day > 31) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  // Parse hora H:MMam/pm or HH:MMam/pm\n  const horaMatch = hora.match(/^(\\d{1,2}):(\\d{2})\\s*(am|pm)$/i);\n  if (!horaMatch) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }\n\n  let hours = parseInt(horaMatch[1], 10);\n  const minutes = parseInt(horaMatch[2], 10);\n  const ampm = horaMatch[3].toLowerCase();\n\n  // Convert to 24-hour format\n  if (ampm === 'pm' && hours !== 12) {\n    hours += 12;\n  } else if (ampm === 'am' && hours === 12) {\n    hours = 0;\n  }\n\n  // ✅ FIX CRÍTICO: Crear ISO string con timezone EXPLÍCITO de Lima (-05:00)\n  try {\n    // Construir string ISO con offset de Lima\n    const limaDateString = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2,\n  '0')}T${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:00-05:00`;\n\n    // JavaScript Date convierte automáticamente a UTC\n    const dateObj = new Date(limaDateString);\n\n    // Validar que la fecha es válida\n    if (isNaN(dateObj.getTime())) {\n      return [{ json: { horario_visita_timestamp: null } }];\n    }\n\n    // Retornar ISO string en UTC (ya convertido correctamente)\n    return [{ json: { horario_visita_timestamp: dateObj.toISOString() } }];\n\n  } catch (e) {\n    return [{ json: { horario_visita_timestamp: null } }];\n  }"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        128
      ],
      "id": "85bf97ba-960d-41ea-be89-0990f966b845",
      "name": "Parse Horario to Timestamp"
    },
    {
      "parameters": {
        "url": "https://raw.githubusercontent.com/iterruptivo/ecoplaza-agente-ia/refs/heads/main/ecoplaza-instrucciones-agente.txt",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3984,
        -48
      ],
      "id": "77c15b11-f541-433c-9477-2b6352d743e7",
      "name": "HTTP Request (GitHub)",
      "credentials": {
        "httpHeaderAuth": {
          "id": "ilMGirJWHVtqUPrH",
          "name": "Header Auth account (githup)"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/{{ $json.phone_number_id }}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $json.message_id }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4272,
        -48
      ],
      "id": "f43c61a0-78ee-46cb-843e-74b714400318",
      "name": "HTTP Request - Mark Message as Read",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const v = $json.body.entry[0].changes[0].value;\nconst telefono = v.messages[0].from;\n\nreturn [{\n  json: {\n    phone_number_id: v.metadata.phone_number_id,\n    message_id: v.messages[0].id,\n    telefono: telefono,\n    body: $json.body\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4592,
        -48
      ],
      "id": "3494b4ba-0a1a-4c07-a58d-3c18e09182f2",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "Eres un asistente que resume conversaciones de WhatsApp para CRM.\nDevuelve SOLO un JSON válido con:\n{\n  \"resumen_historial\": string\n}\nReglas:\n- \"resumen_historial\": síntesis clara y fiel de TODO el historial (sin inventar).\n- No incluyas comentarios; solo JSON válido.",
              "role": "system"
            },
            {
              "content": "=HISTORIAL COMPLETO:\n{{ $json.historial_conversacion || '' }}"
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -3392,
        496
      ],
      "id": "7c50bed9-0eed-4517-9fcf-5b944ce7fd28",
      "name": "OpenAI Summarize History",
      "credentials": {
        "openAiApi": {
          "id": "WhavwmgjOQKegim4",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "clashHandling": {
            "values": {
              "resolveClash": "preferInput1",
              "overrideEmpty": true
            }
          },
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2640,
        368
      ],
      "id": "17be195d-d5d6-4c76-ba8b-c8e069796089",
      "name": "Merge1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ea392d8-056e-48f8-ae01-4d9bd10de00a",
              "name": "resumen_historial",
              "value": "={{ $json.message?.content?.resumen_historial || $json.resumen_historial || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2880,
        464
      ],
      "id": "943b757d-6374-4ef8-b4b6-ee48b3cb0c13",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "81984b69-9b4d-4bf1-8e5e-9caaa32c34bf",
              "leftValue": "={{ $json.estado }}",
              "rightValue": "=en_conversacion",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2464,
        304
      ],
      "id": "5bf4f4ee-d6e6-4259-bf7c-54ff826170ba",
      "name": "IF - Conversacion Cerrada?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v21.0/859011830622528/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.vendor_phone }}\",\n  \"text\": {\n    \"body\": \"{{ $json.notification_message }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -400,
        -304
      ],
      "id": "33e15caf-90e7-4797-bf6a-cc91f4012784",
      "name": "WhatsApp - Send Vendor Notification",
      "credentials": {
        "httpCustomAuth": {
          "id": "vYJ67DysgTKJEf0q",
          "name": "WhatsApp Graph API (Custom - Business iterruptivo)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": " // Obtener datos del lead desde Code2\n  const leadData = $node[\"Code2\"]?.json || {};\n\n  // Capturar estado SOLO si es la primera notificación\n  const estado_al_notificar = leadData.notificacion_enviada === false\n    ? leadData.estado\n    : leadData.estado_al_notificar;\n\n  // Marcar como notificado\n  return [{\n    json: {\n      ...leadData,\n      notificacion_enviada: true,\n      estado_al_notificar: estado_al_notificar\n    }\n  }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -944,
        0
      ],
      "id": "f05e28cf-6ad7-4360-a242-241cfa83d272",
      "name": "Code - Get First Item"
    },
    {
      "parameters": {
        "jsCode": "// === 1) Lead desde el nodo \"IF - Conversacion Cerrada?\" ===\nconst leadItem = $items(\"IF - Conversacion Cerrada?\", 0, 0);\nconst leadData = leadItem?.json || {};\n\n// Obtener el estado desde Code2 (es la fuente más confiable)\nconst estado = leadData.estado || $node[\"Code2\"]?.json?.estado || \"en_conversacion\";\n\n// === 2) Vendedores ===\nconst vendedores = $input.all();\n\n// === 3) Formatear estado y mensaje ===\nconst estadoUpper = estado.toUpperCase().replace(/_/g, \" \");\nconst mensaje = `Nuevo Lead Proyecto Trapiche - Estado: ${estadoUpper}`;\n\n// === 4) Crear items por vendedor ===\nreturn vendedores\n  .map(v => v?.json)\n  .filter(v => v && v.telefono)\n  .map(v => ({\n    json: {\n      vendor_phone: v.telefono,\n      vendor_name: v.nombre,\n      notification_message: mensaje,\n      ...leadData,\n    },\n  }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -896,
        -320
      ],
      "id": "53d78863-cb74-4b05-9bf6-a9011b963853",
      "name": "Code - Format Vendor Notifications"
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -688,
        -320
      ],
      "id": "d0d75374-b184-4864-bbbf-dc9d31900714",
      "name": "Split In Batches - Vendors"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -624,
        16
      ],
      "id": "7f427649-d00d-45f5-8925-f6114e549f9b",
      "name": "Wait",
      "webhookId": "41dbb475-8fe4-462f-ac42-e49e08f0d1b9"
    },
    {
      "parameters": {
        "url": "=https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/leads?telefono=eq.{{ $node[\"Webhook: Recibir WhatsApp\"].json.body.entry[0].changes[0].value.messages[0].from }}&select=*",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3696,
        -48
      ],
      "id": "61a5ccc2-1148-47fb-b527-1354c8bbcd6f",
      "name": "Supabase - Get Lead",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/leads",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "telefono",
              "value": "={{ $json.telefono }}"
            },
            {
              "name": "nombre",
              "value": "={{ $json.nombre }}"
            },
            {
              "name": "rubro",
              "value": "={{ $json.rubro }}"
            },
            {
              "name": "horario_visita",
              "value": "={{ $json.horario_visita }}"
            },
            {
              "name": "horario_visita_timestamp",
              "value": "={{ $json.horario_visita_timestamp }}"
            },
            {
              "name": "estado",
              "value": "={{ $json.estado }}"
            },
            {
              "name": "historial_conversacion",
              "value": "={{ $json.historial_conversacion }}"
            },
            {
              "name": "historial_reciente",
              "value": "={{ $json.historial_reciente }}"
            },
            {
              "name": "resumen_historial",
              "value": "={{ $json.resumen_historial }}"
            },
            {
              "name": "ultimo_mensaje",
              "value": "={{ $json.ultimo_mensaje }}"
            },
            {
              "name": "intentos_bot",
              "value": "={{ $json.intentos_bot }}"
            },
            {
              "name": "fecha_captura",
              "value": "={{ $json.fecha_captura }}"
            },
            {
              "name": "notificacion_enviada",
              "value": "={{ $json.notificacion_enviada }}"
            },
            {
              "name": "estado_al_notificar",
              "value": "={{$json.estado_al_notificar}}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1072,
        336
      ],
      "id": "cced67a5-fd77-403a-9f0e-11c88b89c4f8",
      "name": "Supabase - Upsert Lead"
    },
    {
      "parameters": {
        "url": "https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/vendedores?activo=eq.true&select=*",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1088,
        -320
      ],
      "id": "0e021670-7d5e-4b3c-9054-2aff6ea2a554",
      "name": "Supabase - Get Vendedores"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "62b93104-2e80-460f-9646-337343ff3daa",
              "leftValue": "={{ !$json.notificacion_enviada }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1504,
        -96
      ],
      "id": "b7d5eebf-ddc8-4f5d-8d63-ed52f628e3e0",
      "name": "If1"
    },
    {
      "parameters": {
        "url": "=https://qssefegfzxxurqbzndrs.supabase.co/rest/v1/leads?telefono=eq.{{ $json.telefono }}&select=*",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzc2VmZWdmenh4dXJxYnpuZHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMjA2MTEsImV4cCI6MjA3NTY5NjYxMX0.O6GW7ODPKK4asqDpsnA5Ejn11r_bz3Eklp5qk-1QOiQ"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2176,
        160
      ],
      "id": "d649c816-7817-4974-9328-83ee884b7926",
      "name": "Supabase - Get Lead1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "5pHMC1T78XfLbQ81",
          "name": "Supabase API Key"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook: Recibir WhatsApp": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code - Extract Audio Info",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "OpenAI - Extract Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "OpenAI Summarize History",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Extract Audio Info": {
      "main": [
        [
          {
            "node": "HTTP Request - Get Audio URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Get Audio URL": {
      "main": [
        [
          {
            "node": "HTTP Request - Download Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Download Audio": {
      "main": [
        [
          {
            "node": "OpenAI - Whisper Transcribe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Whisper Transcribe": {
      "main": [
        [
          {
            "node": "Code - Format Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Format Transcription": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Extract Data": {
      "main": [
        [
          {
            "node": "Parse Horario to Timestamp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Horario to Timestamp": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request (GitHub)": {
      "main": [
        [
          {
            "node": "Supabase - Get Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Mark Message as Read": {
      "main": [
        [
          {
            "node": "HTTP Request (GitHub)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request - Mark Message as Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Summarize History": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "IF - Conversacion Cerrada?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "IF - Conversacion Cerrada?": {
      "main": [
        [
          {
            "node": "Supabase - Get Lead1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase - Upsert Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp - Send Vendor Notification": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Get First Item": {
      "main": [
        [
          {
            "node": "Supabase - Upsert Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code - Format Vendor Notifications": {
      "main": [
        [
          {
            "node": "Split In Batches - Vendors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches - Vendors": {
      "main": [
        [
          {
            "node": "Code - Get First Item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WhatsApp - Send Vendor Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Split In Batches - Vendors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Lead": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Upsert Lead": {
      "main": [
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Vendedores": {
      "main": [
        [
          {
            "node": "Code - Format Vendor Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Supabase - Get Vendedores",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase - Upsert Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Lead1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "9b6be1bd-a879-447d-85f3-3ac1b2fe64e7",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ac495b013a9dddb9724430276f2a1ebc03086cb4690790d0c3f0b57736633d28"
  },
  "id": "dneNgFYdWfFPDOzH",
  "tags": [
    {
      "createdAt": "2025-10-05T15:49:21.676Z",
      "updatedAt": "2025-10-05T15:49:21.676Z",
      "id": "kW6ZhQEWOP50a5HL",
      "name": "IA Agent Bot"
    }
  ]
}